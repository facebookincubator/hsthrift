# Building and testing

First install all dependencies (see [Dependencies](#Dependencies) section below).

Then, build a local checkout of `cabal-install`'s master branch
using commit `f5f8d933db229d30e6fc558f5335f0a4e85d7d44` or
newer. The aforementioned commit will be available in the
3.6 release of `Cabal` and `cabal-install`.

We then use the C++ thrift compiler to generate some files needed
to build the Haskell thrift compiler, which we can do immediately
afterwards.

``` sh
$ make thrift-cpp
$ cabal build exe:thrift-compiler
```

At this point, you should have a working `thrift-compiler`. You can
check that this is indeed the case by running the following
command to process many `.thrift` files used by tests of various
packages in this repository with your freshly built compiler:

``` sh
$ make thrift-hs
```

Before proceeding to building and testing everything, we just need to
copy some testing related modules around that are used by several
packages, using a simple make command:

``` sh
$ make copy-sources
```

Finally, we can issue any `cabal build`/`cabal run`/`cabal test`
command to build/run/test a specific component or entire package.
For instance, we could test all the packages with:

``` sh
$ cabal test all

# or, if there's no IPv6 configured on your machine (see below),
# you can borrow the ci configuration or derive your own:
$ cabal test --project-file=ci.cabal.project all
```

## Source distributions

In order to generate self-contained source distribution archives for
the packages from this repository, you must first run:

``` sh
$ make prepare-sdists
```

which will copy around many files that were generated by
`make thrift-hs`, as there currently are quite a few inter-package
dependencies when it comes to test files. Then, a simple

``` sh
$ cabal sdist <package name>
# or, to generate all sdists
$ cabal sdist all
```

will generate source distribution archives under
`dist-newstyle/sdist/`, all named following the fairly common
`<pkg>-<version>.tar.gz` template.

The Github CI actions make use of these commands to build and test
the packages from source distributions.

## IPv4 vs IPv6

Some tests bring up thrift clients and servers on localhost, but
designate the said localhost differently depending on whether the
code is built to use `::1` (IPv6) or `127.0.0.1` (IPv4). This is
determined by a `tests_use_ipv4` cabal flag in `thrift-lib` and
`thrift-server`. The Github CI actions turn those flags on as can
be seen in the `.cabal.project` files at the root of this repository,
because the Docker environment in which CI actions get executed does
not have IPv6 configured.

# Dependencies

The following instructions worked on Ubuntu 16.04, please update as
necessary for other distros/versions.

TODO: automate all this with scripts.

## glog

required by: various things

sudo apt install libgoogle-glog-dev

## gflags

sudo apt install libgflags-dev

## folly

Required by: fbthrift, fb-util

NOTE: make sure that folly, fizz, wangle are all checked out at the same tag. e.g. I used v2019-10-07-00

```
git clone git@github.com:simonmar/folly.git
```

(my fork has a couple of changes)

edit `CMake/libfolly.pc.in` to set:

Version: ﻿2020.07.10.00﻿

(otherwise Cabal complains that it can't parse the version "master" in
the `pkg-config --modversion` output)

follow instructions in `README.md` except for:

`cmake -DBUILD_SHARED_LIBS=ON ..`

(because we always build dynamic versions of Haskell libs, for GHCi,
and otherwise this will fail saying it needs -fPIC)

```
sudo make install # puts files under /usr/local
```

## bison/flex

required by: fbthrift

```
sudo apt install bison flex
```

## rsocket / yarpl

required by: fbthrift

```
git clone ﻿git@github.com﻿:rsocket/rsocket-cpp.git
```

follow build instructions, but add to cmake: `-DBUILD_SHARED_LIBS=ON`

## fizz

required by: fbthrift

follow instructions at ﻿https://github.com/facebookincubator/fizz﻿

```
cmake ../fizz -DBUILD_SHARED_LIBS=ON
```

## wangle

required by: fbthrift

follow instructions at ﻿`https://github.com/facebook/wangle﻿`

```
cd wangle
cmake . -DBUILD_SHARED_LIBS=ON
```

## zstd

required by: fbthrift, rocksdb

```
sudo apt install libzstd-dev
```

## fmt

required by: fbthrift

﻿https://github.com/fmtlib/fmt﻿

NB: checkout version 6.1.1 (the one currently in tp2), master doesn’t necessarily work

Apply this patch (TODO: not sure if this is actually needed (2020-07-10)):
```
diff --git a/CMakeLists.txt b/CMakeLists.txt
index f872e3c9..bf684171 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -161,6 +161,8 @@ endif ()
 add_library(fmt ${FMT_SOURCES} ${FMT_HEADERS} README.rst ChangeLog.rst)
 add_library(fmt::fmt ALIAS fmt)
 
+set_target_properties(fmt PROPERTIES POSITION_INDEPENDENT_CODE True)
+
 if (FMT_WERROR)
   target_compile_options(fmt PRIVATE ${WERROR_FLAG})
 endif ()
```

build & install as per instructions

## fbthrift

```
git clone https://github.com/facebook/fbthrift
cd fbthrift/build
cmake .. -DBUILD_SHARED_LIBS=ON
make -j2 && sudo make install
```

## rocksdb

required by: Glean

```
sudo apt install librocksdb-dev
```

## MySQL client lib

required by: some modules in fb-util

```
sudo apt install libmysqlclient-dev
```
